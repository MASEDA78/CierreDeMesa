function calcularPorcentajes() {
  const candidatos = document.querySelectorAll('.candidate');
  const votos = [];
  let totalVotos = 0;

  candidatos.forEach(c => {
    const nombre = c.dataset.name;
    const partido = c.dataset.party;
    const img = c.dataset.img;
    const valor = parseInt(c.querySelector('input').value) || 0;

    if (valor < 0) {
      alert(`Voto inv√°lido para ${nombre}.`);
      return;
    }

    votos.push({ nombre, partido, img, votos: valor });
    totalVotos += valor;
  });

  if (totalVotos === 0) {
    alert("Ingres√° al menos un voto v√°lido.");
    return;
  }

  let porcentajes = votos.map(c => (c.votos / totalVotos) * 100);
  let porcentajesRedondeados = porcentajes.map(p => Math.floor(p * 100) / 100);
  let suma = porcentajesRedondeados.reduce((acc, p) => acc + p, 0);
  let diferencia = parseFloat((100 - suma).toFixed(2));

  if (diferencia !== 0) {
    let residuos = porcentajes.map((p, i) => ({ i, residuo: p - porcentajesRedondeados[i] }));
    residuos.sort((a, b) => b.residuo - a.residuo);
    porcentajesRedondeados[residuos[0].i] += diferencia;
  }

  mostrarResultadosSimples(votos, porcentajesRedondeados, totalVotos);
  generarMensajeWhatsApp(votos, porcentajesRedondeados, totalVotos);
  enviarPorWhatsApp(votos, porcentajesRedondeados, totalVotos);
}

function mostrarResultadosSimples(votos, porcentajes, totalVotos) {
  const contenedor = document.getElementById('resultados');
  contenedor.innerHTML = '';

  const mesa = document.getElementById('mesa').value || "Mesa sin n√∫mero";
  const fiscal = document.getElementById('fiscal').value || "Fiscal sin nombre";

  const resumen = document.createElement('div');
  resumen.innerHTML = `
    <h3>üìç Mesa ${mesa} ‚Äì Fiscal: ${fiscal}</h3>
    <p><strong>Total de votos:</strong> ${totalVotos}</p>
    <p><strong>Suma de porcentajes:</strong> 100.00%</p>
  `;
  contenedor.appendChild(resumen);

  votos.forEach((c, i) => {
    const porcentaje = porcentajes[i].toFixed(2);
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <img src="${c.img}" alt="${c.nombre}" />
      <div class="info">
        <h3>${c.nombre}</h3>
        <p><strong>Partido:</strong> ${c.partido}</p>
        <p><strong>Votos:</strong> ${c.votos}</p>
        <p><strong>Porcentaje:</strong> ${porcentaje}%</p>
      </div>
    `;
    contenedor.appendChild(card);
  });
}

function generarMensajeWhatsApp(votos, porcentajes, totalVotos) {
  const mesa = document.getElementById('mesa').value || "Mesa sin n√∫mero";
  const fiscal = document.getElementById('fiscal').value || "Fiscal sin nombre";

  let mensaje = `üó≥Ô∏è *Resultados ‚Äì Mesa ${mesa}, Fiscal ${fiscal}*\n\n`;
  votos.forEach((c, i) => {
    const porcentaje = porcentajes[i].toFixed(2);
    mensaje += `‚Ä¢ ${c.nombre} (${c.partido}): ${c.votos} votos ‚Äì ${porcentaje}%\n`;
  });
  mensaje += `\nüìä Total de votos: ${totalVotos}\n‚úÖ Porcentajes suman: 100.00%`;

  const contenedor = document.getElementById('resultados');
  const bloque = document.createElement('div');
  bloque.innerHTML = `
    <textarea readonly>${mensaje}</textarea>
    <p><strong>üì§ Copi√° y peg√° este mensaje en WhatsApp</strong></p>
  `;
  contenedor.appendChild(bloque);
}

function enviarPorWhatsApp(votos, porcentajes, totalVotos) {
  const mesa = document.getElementById('mesa').value || "Mesa sin n√∫mero";
  const fiscal = document.getElementById('fiscal').value || "Fiscal sin nombre";

  let mensaje = `üó≥Ô∏è *Resultados ‚Äì Mesa ${mesa}, Fiscal ${fiscal}*\n\n`;
  votos.forEach((c, i) => {
    const porcentaje = porcentajes[i].toFixed(2);
    mensaje += `‚Ä¢ ${c.nombre} (${c.partido}): ${c.votos} votos ‚Äì ${porcentaje}%\n`;
  });
  mensaje += `\nüìä Total de votos: ${totalVotos}\n‚úÖ Porcentajes suman: 100.00%`;

  const numero = "5491168650195";
  const url = `https://wa.me/${numero}?text=${encodeURIComponent(mensaje)}`;
  window.open(url, '_blank');
}

async function generarPDFConEncabezado() {
  const resultados = document.getElementById('resultados');
  if (!resultados) {
    alert("Gener√° primero los resultados.");
    return;
  }

  const mesa = document.getElementById('mesa').value || "Sin n√∫mero";
  const fiscal = document.getElementById('fiscal').value || "Sin nombre";

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p', 'mm', 'a4');
  const pageWidth = pdf.internal.pageSize.getWidth();

  const logo = new Image();
  logo.src = 'https://raw.githubusercontent.com/MASEDA78/CierreDeMesa/main/desender.png';

  logo.onload = async () => {
    pdf.addImage(logo, 'PNG', 10, 10, 30, 30);
    pdf.setFontSize(16);
    pdf.text(`Cierre de Mesa ${mesa} ‚Äì Fiscal ${fiscal}`, 50, 20);
    pdf.setLineWidth(0.5);
    pdf.line(10, 35, pageWidth - 10, 35);

    const canvas = await html2canvas(resultados, { scale: 2 });
    const imgData = canvas.toDataURL('image/png');
    const imgProps = pdf.getImageProperties(imgData);
    const ratio = imgProps.width / imgProps.height;
    const pdfWidth = pageWidth - 20;
    const pdfHeight = pdfWidth / ratio;

    pdf.addImage(imgData, 'PNG', 10, 40, pdfWidth, pdfHeight);
    pdf.save(`Cierre_Mesa_${mesa}.pdf`);
  };
}
